<html>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4D6N4P07B7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4D6N4P07B7');
    </script>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  </head>
  <body>
    <audio id="scream" src="scream.mp3" type="audio/mpeg"></audio>
    <audio id="snare" src="snare.wav" type="audio/wav"></audio>
    <script>
   
      let timePerTile = 800;
      let timeTilDead = 1500;  

      let player = {x: 0, z: 0};
      let tiles = [];
      let moving = false;
      let gameRunning = true;
      let moveRequested = false;
      let timeClicked;

      let tileDestination = {x:0, z:0};

      function isInline(tile) {
         console.log("is inline?: " + tile.id + ": " + tile.x + ", " + tile.z);
         // TODO: Update this to take into account whether there is actually tiles all the way up to the destination tile.  
         if (player.x === tile.x || player.z === tile.z) {
          console.log('this is inline');
          return true;
         }
         return false;
      }

      function printBelowTile(x, z, time) {

        for (num in tiles) {
          let tile = tiles[num];
          let minX = tile.x - 0.5;
          let maxX = tile.x + 0.5;
          let minZ = tile.z - 0.5;
          let maxZ = tile.z + 0.5;
        

          if (x > minX && x < maxX && z > minZ && z < maxZ) {
            console.log('Current below tile num = ' + num);
            console.log('Current below tile id = ' + tile.id);
            removeTile(tile, time);
          }
        }

      } 

      function getCurrentBelowTile(x, z) {
        for (num in tiles) {
          let tile = tiles[num];
          let minX = tile.x - 0.5;
          let maxX = tile.x + 0.5;
          let minZ = tile.z - 0.5;
          let maxZ = tile.z + 0.5;
        

          if (x > minX && x < maxX && z > minZ && z < maxZ) {
            console.log('getCurrent below tile. id = ' + tile.id + ', status = ' + tile.status);
            return tile;
          }
        }
      }

      function removeTile(tile, time) {
        // TODO do this slowly over time rather than instantly
        let tileElem = document.getElementById(tile.id);
        if (tileElem) {
          tile.status = 'dead';
          tile.timeDead = time;
          tileElem.remove();
        }
      }

      AFRAME.registerComponent('updater', {

        tick: function(time, timeDelta) {
          if (!gameRunning) {
            return;
          }

          if (!moving) {
             let currentBelowTile = getCurrentBelowTile(player.x, player.z);
              if (currentBelowTile.status == 'dead' && time > (currentBelowTile.timeDead + timeTilDead) && currentBelowTile.id != 'box0') {
                document.getElementById('scream').play();
                console.log("GAME OVER!! at tile: " + currentBelowTile.id);
                gameRunning = false;
              } 
          }

          

          if (moveRequested && !moving) {
            console.log('move has been requested');
            moving = true;

            // Reset moveRequested back to false
            moveRequested = false;
            timeClicked = time;
            console.log('player = ' + player.x + ',' + player.z);

          }

          if (moving) {
            //console.log('i should be moving!');
            let diff = time - timeClicked;
            let toMove = diff / timePerTile;
  
            let xDirection;
            if (tileDestination.x > player.x) {
              xDirection = 1;
            } else if (tileDestination.x == player.x) {
              xDirection = 0;
            } else {
              xDirection = -1;
            }

            let zDirection;
            if (tileDestination.z > player.z) {
              zDirection = 1;
            } else if (tileDestination.z == player.z) {
              zDirection = 0;
            } else {
              zDirection = -1;
            }

            let xSpeed = (tileDestination.x - player.x) * xDirection;

            let zSpeed = (tileDestination.z - player.z) * zDirection;
            //console.log('xspeed = ' + xSpeed + ', zspeed='  + zSpeed+ ', zDirection=' + zDirection);

           // let newX = ((tileDestination.x - player.x) * toMove) + player.x;
           // let newZ = ((tileDestination.z - player.z) * toMove) + player.z;

         //  let newX = (xDirection * speed * diff )  + player.x;
         //  let newZ = (zDirection * speed * diff )  + player.z;

            let newX = (xDirection * toMove) + player.x;
            let newZ = (zDirection * toMove) + player.z;

            printBelowTile(newX, newZ, time);
       
            document.getElementById('camera-entity').setAttribute('position', newX + ' 1.6 ' + newZ);
            document.getElementById('controls').setAttribute('position', newX + ' 1.6 ' + newZ);

            let finishedDiff = (tileDestination.x - player.x) + (tileDestination.z - player.z); 


            if (time - timeClicked >= (timePerTile * Math.max(xSpeed, zSpeed))) {
              moving = false;
              player.x = tileDestination.x;
              player.z = tileDestination.z;


            } 
          }

        /*  if (moving && time > timeClicked + 1000 ) {

            console.log('do a move');
            
            moving = false;
          }*/
          
        }
      });

     
      AFRAME.registerComponent('raycaster-listener', {
        init: function() {
          this.el.addEventListener('raycaster-intersected', function(evt) {
            console.log('intersected element with id: ' + evt.target.id);
            //this.el.setAttribute('material', 'color', 'blue');
            for (tile in tiles) {
              if (evt.target.id == tiles[tile].id && isInline(tiles[tile])) {
                document.getElementById(tiles[tile].id).setAttribute('material', 'color', 'blue');
             
              } else {
              
             //   document.getElementById(tiles[tile]).removeAttribute('material', 'color');
              }
            }
          });

          this.el.addEventListener('raycaster-intersected-cleared', function(evt) {
            console.log('intersect cleared element with id: ' + evt.target.id);
           // this.el.removeAttribute('material', 'color');
             for (tile in tiles) {
              if (evt.target.id == tiles[tile].id) {
                document.getElementById(tiles[tile].id).removeAttribute('material', 'color');
                
              } else {
                
               // document.getElementById(tiles[tile]).removeAttribute('material', 'color');
              }
            }
          });

          this.el.addEventListener('click', function (evt) {
            console.log('raycaster-listener click');
            
            for (tile in tiles) {
              if (evt.target.id == tiles[tile].id && isInline(tiles[tile])) {
                //document.getElementById('scream').play();
                moveRequested = true;
                tileDestination.x = tiles[tile].x;
                tileDestination.z = tiles[tile].z;
              }
            }
          });


        }
      });

      // This listens to the retical when you are viewing the page on desktop (and presumably on Android web aswell)
      AFRAME.registerComponent('cursor-listener', {
  init: function () {
    
    this.el.addEventListener('mouseenter', function (evt) {
    //  console.log("entering " + evt.target.id);
    console.log('cursor-listener mouseenter');

      for (tile in tiles) {
        if (tiles[tile].status == 'dead') continue;
        if (evt.target.id == tiles[tile].id && isInline(tiles[tile])) {
          document.getElementById(tiles[tile].id).setAttribute('material', 'color', 'blue');
        } else {
          document.getElementById(tiles[tile].id).removeAttribute('material', 'color');
        }
      }

     // console.log('I was clicked at: ', evt.detail.intersection.point);
    });

    this.el.addEventListener('mouseleave', function (evt) {
      console.log('cursor-listener mouseleave')
    //  console.log("leaving " + evt.target.id);
      this.removeAttribute('material', 'color');
      
    });

    this.el.addEventListener('click', function (evt) {
      console.log('cursor-listener click');
     // document.getElementById('snare').play();
      console.log('Clicked item position: ' + evt.target.getAttribute('position'));

      var position = evt.target.getAttribute('position');

      // var cameraPosition = {};
      // cameraPosition['x'] = position['x'];
      // cameraPosition['y'] = '1.6';
      // cameraPosition['z'] = position['z'];
      newPositionString = position['x'] + ' 0 ' + position['z'];

      console.log('I was clicked at: ', evt.detail.intersection.point);

      
    });
  }
});
    </script>
    <a-scene id="scene" updater>

      <a-entity id='controls' position="0 1.6 0">      
          <a-entity laser-controls="hand: left" raycaster="objects: .clickable"></a-entity>
        
    
          <a-entity laser-controls="hand: right" raycaster="objects: .clickable"></a-entity>
      </a-entity>
      
      <a-assets>
        <a-asset-item id="saucer-obj" src="saucernormals.obj" ></a-asset-item>
        <a-asset-item id="saucer-mtl" src="saucernormals.mtl"></a-asset-item>
      </a-assets>
      <a-entity obj-model="obj: #saucer-obj; mtl: #saucer-mtl" scale="0.2 0.2 0.2" position="3 2 -4" >
       
       
        <a-animation attribute="rotation"
               dur="1000"
               fill="forwards"
               to="0 360 0"
               easing="linear"
               repeat="indefinite"></a-animation>
              
      </a-entity>
      <a-sphere position="-4 0.75 -6" radius="0.25" color="#EF2D5E"></a-sphere>
      <a-cylinder position="0 0.75 -4" radius="0.5" height="1.5" color="#FFC65D"></a-cylinder>
      <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
      <a-sky color="#ECECEC"></a-sky>

      <a-box raycaster-listener cursor-listener class="clickable" id="evert" material="src: evs.jpg;" position="0 2 -5" rotation="0 45 45" scale="1 1 1" 
      animation="property: object3D.position.y; to: 6; dir: alternate; dur: 3000; loop: true"
      animation="property: object3D.rotation.y; to: 0.8; dir: alternate; dur: 500; loop: true"></a-box>

      <a-box raycaster-listener cursor-listener class="clickable" id="elmo" material="src: elmo.jpg;" position="-2 4 -2" rotation="0 45 45" scale="1 1 1" 
      animation="property: object3D.position.y; to: 3; dir: alternate; dur: 900; loop: true"
      animation="property: object3D.rotation.y; to: 0.8; dir: alternate; dur: 500; loop: true"></a-box>

      <a-box raycaster-listener cursor-listener class="clickable" id="lils" material="src: lils.jpg;" position="1 4 -2" rotation="0 45 45" scale="1 1 1" 
      animation="property: object3D.position.y; to: 3; dir: alternate; dur: 1200; loop: true"
      animation="property: object3D.rotation.y; to: 0.8; dir: alternate; dur: 500; loop: true"></a-box>

      <a-box raycaster-listener cursor-listener class="clickable" id="arley" material="src: arley.jpg;" position="4 6 -3" rotation="0 0 45" scale="1 1 1" 
      animation="property: object3D.position.y; to: 3; dir: alternate; dur: 500; loop: true"
      animation="property: object3D.rotation.y; to: 0.8; dir: alternate; dur: 500; loop: true"></a-box>

     
     <!-- 
      <a-box class="clickable" id="abox1" raycaster-listener cursor-listener position="0 0.5 0" height="0.05" material="src: greytile.jpg;"></a-box>
      <a-box class="clickable" id="abox2" raycaster-listener cursor-listener position="0 0.5 -1" height="0.05" material="src: whitetile.jpg;"></a-box>
      <a-box class="clickable" id="abox3" raycaster-listener cursor-listener position="0 0.5 -2" height="0.05" material="src: greytile.jpg;"></a-box>
      <a-box class="clickable" id="abox4" raycaster-listener cursor-listener position="0 0.5 -3" height="0.05" material="src: whitetile.jpg;"></a-box>
      <a-box class="clickable" id="abox5" raycaster-listener cursor-listener position="-1 0.5 -3" height="0.05" material="src: greytile.jpg;"></a-box>
      <a-box class="clickable" id="abox6" raycaster-listener cursor-listener position="-2 0.5 -3" height="0.05" material="src: whitetile.jpg;"></a-box>
      <a-box class="clickable" id="abox7" raycaster-listener cursor-listener position="-3 0.5 -3" height="0.05" material="src: greytile.jpg;"></a-box>
      <a-box class="clickable" id="abox8" raycaster-listener cursor-listener position="-3 0.5 -4" height="0.05" material="src: whitetile.jpg;"></a-box>
      <a-box class="clickable" id="abox9" raycaster-listener cursor-listener position="-3 0.5 -5" height="0.05" material="src: greytile.jpg;"></a-box>
      <a-box class="clickable" id="abox10" raycaster-listener cursor-listener position="-2 0.5 -5" height="0.05" material="src: whitetile.jpg;"></a-box>
      <a-box class="clickable" id="abox11" raycaster-listener cursor-listener position="-1 0.5 -5" height="0.05" material="src: greytile.jpg;"></a-box>
      <a-box class="clickable" id="abox12" raycaster-listener cursor-listener position="-1 0.5 -6" height="0.05" material="src: whitetile.jpg;"></a-box>
      <a-box class="clickable" id="abox13" raycaster-listener cursor-listener position="-2 0.5 -6" height="0.05" material="src: greytile.jpg;"></a-box>
      <a-box class="clickable" id="abox14" raycaster-listener cursor-listener position="-3 0.5 -6" height="0.05" material="src: whitetile.jpg;"></a-box>
      <a-box class="clickable" id="abox15" raycaster-listener cursor-listener position="-4 0.5 -6" height="0.05" material="src: greytile.jpg;"></a-box>
-->
      <a-entity id='camera-entity' position="0 1.6 0">
        <a-camera id='camera-test'>
        
   <!-- TODO  Put this back in to get the gaze pointer thing. -->
       <a-entity cursor="fuse: false; fuseTimeout: 500"
            position="0 0 -1"
            geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.028"
            material="color: black; shader: flat"> 

          </a-entity> 
        </a-camera>
      </a-entity>
    </a-scene>

    <script>
      
      const floorLevel = 0.5;

      let steps = [
        {x: 0, z: 0},
        {x: 0, z: -1},
        {x: 0, z: -2},
        {x: 0, z: -3},
        {x: -1, z: -3},
        {x: -2, z: -3},
        {x: -3, z: -3},
        {x: -3, z: -4},
        {x: -3, z: -5},
        {x: -2, z: -5},
        {x: -1, z: -5},
        {x: -1, z: -6},
        {x: -2, z: -6},
        {x: -3, z: -6},
        {x: -4, z: -6},
      ];

      let scene = document.getElementById('scene');

     // tiles.push({x: 0, z: 0, id: 'evert'});
     // tiles.push({x: 0, z: 0, id: 'arley'});
     // tiles.push({x: 0, z: 0, id: 'elmo'});
     //  tiles.push({x: 0, z: 0, id: 'lils'});

      for (num in steps) {
        let step = steps[num];
        console.log('step = ' + step);
        let id = "box" + num;
        
        let aTile = document.createElement('a-box');
        aTile.setAttribute('id', id);
        tiles.push({x: step.x, z: step.z, id: id, status: 'live'});
        aTile.setAttribute('class', 'clickable');
        if ((step.x + step.z) % 2 == 0) {
          aTile.setAttribute('material', 'src: greytile.jpg;');
        } else {
          aTile.setAttribute('material', 'src: whitetile.jpg;');

        }
        //aTile.setAttribute('material', 'src: greytile.jpg;');
        aTile.setAttribute('height', '0.05');
        aTile.setAttribute('raycaster-listener', "");
        aTile.setAttribute('cursor-listener', "");
        const position = step.x + ' ' + floorLevel + ' ' + step.z;
        console.log('position = ' + position);
        aTile.setAttribute('position', position);
        scene.appendChild(aTile);
      }

      
      
    </script>
  </body>
</html>
